name: Deploy to Production

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Extract version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Build and Push Docker image
              run: |
                  docker buildx build --platform linux/amd64 \
                    -t kimjihye314/lastdance-api:${{ steps.get_version.outputs.VERSION }} \
                    -t kimjihye314/lastdance-api:latest \
                    --push .

            - name: Deploy to Production Server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.PROD_SERVER_HOST }}
                  username: ubuntu
                  key: ${{ secrets.PROD_SERVER_SSH_KEY }}
                  script: |
                      cd ~/2025-C6-M15-LastDance-API/

                      # Git 업데이트
                      git fetch origin
                      git checkout master
                      git pull origin master

                      # Docker 이미지 업데이트
                      docker-compose pull api

                      # 컨테이너 재시작
                      docker-compose down
                      docker-compose up -d --build

                      # 오래된 이미지 정리
                      docker image prune -f

                      echo "Production deployment completed: ${{ steps.get_version.outputs.VERSION }}"

            - name: Health Check
              run: |
                  sleep 10
                  curl -f https://woa-art.com/health || exit 1
                  echo "Health check passed"
