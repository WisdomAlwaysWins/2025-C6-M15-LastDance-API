name: Deploy to Test

on:
    push:
        branches:
            - develop
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker image
              run: |
                  docker buildx build --platform linux/amd64 \
                    --no-cache \
                    -t kimjihye314/lastdance-api:test \
                    -t kimjihye314/lastdance-api:test-${{ github.sha }} \
                    --push .

            - name: Deploy to Test Server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.TEST_SERVER_HOST }}
                  username: ubuntu
                  key: ${{ secrets.TEST_SERVER_SSH_KEY }}
                  script: |
                      cd ~/2025-C6-M15-LastDance-API/

                      # Git 업데이트 
                      git fetch origin
                      git checkout develop
                      git pull origin develop

                      # Docker 이미지 업데이트 
                      docker-compose pull api

                      # 컨테이너 재시작 
                      docker-compose down
                      docker-compose up -d --build

                      # 오래된 이미지 정리 
                      docker image prune -f

                      echo "Test deployment completed"

            - name: Health Check
              run: |
                  sleep 15
                  curl -f http://${{ secrets.TEST_SERVER_HOST }}:8000/health || exit 1
                  echo "Health check passed"
